/*
Example:

antimalware" {
  RealtimeProtectionEnabled      = "true"
  ScheduledScanSettingsIsEnabled = "false"
  ScheduledScanSettingsDay       = "7"
  ScheduledScanSettingsTime      = "120"
  ScheduledScanSettingsScanType  = "Quick"
  ExclusionsExtensions           = ""
  ExclusionsPaths                = ""
  ExclusionsProcesses            = ""
}

*/

variable "antimalware" {
  description = "Should the VM run antimalware"
  default     = null
}

resource "azurerm_virtual_machine_extension" "IaaSAntimalware" {
  count                      = var.antimalware != null && var.deploy ? 1 : 0
  name                       = "IaaSAntimalware"
  depends_on                 = [
    azurerm_virtual_machine_extension.CustomScriptExtension,
    azurerm_virtual_machine_extension.DomainJoinExtension, 
    azurerm_virtual_machine_extension.AADLoginForWindows,
    azurerm_virtual_machine_extension.DAAgentForWindows,
    azurerm_virtual_machine_extension.MicrosoftMonitoringAgent,
    azurerm_virtual_machine_data_disk_attachment.data_disks
  ]
  virtual_machine_id         = azurerm_windows_virtual_machine.VM[0].id
  publisher                  = "Microsoft.Azure.Security"
  type                       = "IaaSAntimalware"
  type_handler_version       = "1.5"
  auto_upgrade_minor_version = true

  settings = <<SETTINGS
        {  
          "AntimalwareEnabled": true,
          "RealtimeProtectionEnabled": "${var.antimalware.RealtimeProtectionEnabled}",
          "ScheduledScanSettings": {
            "isEnabled": "${var.antimalware.ScheduledScanSettingsIsEnabled}",
            "day": "${var.antimalware.ScheduledScanSettingsDay}",
            "time": "${var.antimalware.ScheduledScanSettingsTime}",
            "scanType": "${var.antimalware.ScheduledScanSettingsScanType}"
          },
          "Exclusions": {
            "Extensions": "${var.antimalware.ExclusionsExtensions}",
            "Paths": "${var.antimalware.ExclusionsPaths}",
            "Processes": "${var.antimalware.ExclusionsProcesses}"
          }
        }
  SETTINGS
}
